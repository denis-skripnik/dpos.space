# dpos.space
Сервисы для блокчейнов Steem, Golos, Viz и Whaleshares.

## Характеристики:
1. Язык программирования - PHP;
2. Используемые библиотеки:
php-graphene-node-client: https://github.com/t3ran13/php-graphene-node-client и используемые ею.
parsedown: https://github.com/erusev/parsedown (Используется в backup и profiles).
3. Остальное - мой PHP и JS код.
4. Используется Jquery и Ajax.
5. Выбор блокчейна и смена его url происходит без перезагрузки страницы при клике по кнопке.

## Структура
### 0. Общее:
1. В каждой папке сервиса есть файл с одноимённым названием. Он содержит заголовок сервиса, описание, некоторые специфические (и не очень) переменные.
2. index.php сервисов - основа этих сервисов. В каждом содержатся разные данные.

Сервисы буду перечислять в порядке от основного к второстепенному.

### 1. profiles - сервис просмотра профилей.
- snippets - сниппеты методов блокчейнов:
discussions_by_blog.php - получение всех постов блога, у которых прошла выплата.
Followers_accounts.php - получение из get_accounts информации о подписчике. Используется во вкладке "Подписчики с информацией о каждом".
get_account.php - инфа об аккаунте (get_accounts).
get_account_history.php - файл, получающий информацию из get_account_history.
get_account_history_chunk.php - История пользователей из get_account_history с постраничной навигацией. Это значит, что подгрузка идёт больше лимита.
get_config.php - метод get_config.
get_delegate.php - Метод get_accounts для получение информации о делегатах, за которых проголосовал пользователь.
get_discussions_by_blog.php - Список постов, не получивших выплаты. Метод get_discussions_by_blog.
get_dynamic_global_properties.php - соответствующий метод.
get_feed_history.php - API метод get_feed_history. Используется только для Golos и Steem.
get_follow_count.php - вывод количества подписчиков. Метод get_follow_count.
Get_Followers.php - список подписчиков. Также используется во вкладке "Подписчики с информацией о каждом".
GetContentReplies.php - Получение комментариев пользователя. Метод getDiscussionsByComments.
getRewardFund.php - Метод getRewardFund. Используется в Steem и Whaleshares.
- md - parsedown.
- tabs - файлы вкладок dpos.space/profiles.
author_rewards.php - авторские награды. В Viz - полученные награды.
- b_rewards.php - бенефициарские награды;
- blog-posts.php - Свежие посты. Не выводится в Viz.
- curator_rewards.php - Кураторские награды. В Viz не выводится;
- delegat.php - вкладка "Делегатство": список делегатов пользователя и история установки/снятия голосов за делегатов (Как за тех, кого голосует пользователь, так и за него, если он делегат).
followers.php - подписчики с информацией о каждом.
notefy.php - уведомления от robot. Выводится только для Голоса.
posts_with_payment.php - Посты, получившие выплату. Используется пагинация.На Viz не выводится.
replyse.php - Комментарии. На Viz не выводится.
trx.php - переводы.
userinfo.php - информация о пользователе (Основное).
- index.php - основной файл. Тут идёт ссылка на файл, который задействуется, если пользователь введён, а также выводится форма, если пользователь и блокчейн не выбраны.
- params.php - параметры сервиса: заголовки, описания, переменные.
- user_view.php - форма ввода логина, вкладки с div блоками для вывода их содержимого.

Адрес сервиса: https://dpos.space/profiles
Профиль имеет url: https://dpos.space/profiles/denis-skripnik/viz - открытие профиля аккаунта denis-skripnik в Viz.

### 2. post: сервис публикации постов.
На Визе происходит отправка custom операции в определённом формате. В остальных блокчейнов используется операция comment.
- params.php - параметры сервиса. Помимо стандартных (Заголовки, описание, текст для футера и пр.) есть ещё подключение JS файлов в зависимости от активного блокчейна, javascript код проверки кураторского процента (Golos) и подключение редактора с sjcl (Расшифровка и шифрование ключа).
- index.php - сама Форма постинга, вывод сообщения, если не выбран блокчейн. Также там выводится подключение файла static/interface.js.
- Папка static:
golos.min.js и steem.min.js - файлы либ блокчейнов Golos и Steem;
simplemde.min - JS и CSS файл редактора.
sjcl.min.js - шифрование и дешифровка данных (В нашем случае ключа).
interface.js - настройки формы постинга:
Авторизация и сохранение ключа в зашифрованном виде (Если отмечена галочка), паблик-Ноды блокчейнов, загрузка файлов через imger, редактирование постов с получением их содержимого через get_content, различные параметры блокчейнов (название токена и другие), очистка формы, добавление поста: VIZ - viz.broadcast.custom, другие блокчейны - broadcast.send с отправкой comment и comment_options одной транзакцией.
Также там прописан код для добавления бенефициаров в удобном виде (Без специальных кодов): функции add, update; транслитирация тегов (Функция transform); функция , читающая загруженный *.md файл - handleFileSelectEvent.

Адрес сервиса: https://dpos.space/post
Для Голоса: https://dpos.space/post/golos

### 3. calc: блокчейн-калькулятор.
Сервис определяет стоимость апа (для VIZ - сумму, которую пользователь может дать при награде).
- snippets: сниппеты методов блокчейнов (Тут их меньше):
get_config.php - API метод get_config
get_dynamic_global_properties.php - тоже.
get_feed_history.php - Метод, используемый только в GOLOS/STEEM;
getRewardFund.php - Метод API, используемый в Steem/Whaleshares.
- upvotes - папка, где настраивается всё для определения стоимости апа/награды.
ajax.php - файл, обрабатывающий Ajax запрос от формы. Получает название блокчейна, СГ/sp/WHALESTAKE/SHARES, процент апа и процент батарейки/энергии. В VIZ только SHARES, название БЧ и энергию.
Стоимость определяется при помощи спец. формул, которые от блокчейна к блокчейну отличаются.
block.php - html блок определения стоимости апа. Выводится на странице сервиса.
- vests-gests - файлы те же. Папка отвечает за второй блок сервиса: перевод vests/gests в СГ/sp/WHALESTAKE. В VIZ переводит VIZ в SHARES.
ajax.php принимает только число в gests/vests/VIZ.
- index.php - основной файл. Выводится подключение блоков, а также производится вывод сообщения, если блокчейн не выбран. Кроме того, в этом файле находятся скрипты, принимающие параметры из форм.
- params.php - параметры сервиса. Тут ничего особого нет: просто заголовки и описания сервиса в зависимости от блокчейна, а также если их нет.

https://dpos.space/calc - адрес сервиса.
На примере Steem - это https://dpos.space/calc/steem

### 4. backup
Сервис резервного копирования постов. Для всех блокчейнов, кроме VIZ (Там нет постов, которые можно было бы доставать из блокчейна).
- params.php - параметры сервиса: заголовки, описания.
- index.php - основа сервиса. Выводится сообщение, если блокчейн не выбран, а если выбран - форма бекапа. Плюс, берётся из блокчейна текущего история аккаунта golos-backup или denis-skripnik (В зависимости от блокчейна). Если платёж от аккаунта, которого надо бекапить посты, оплатил, подключается файл из папки generation. Если нет - выводится сообщение.
Подключается тот файл, который нужен: если html выбран в форме - html_generator.php. Если markdown оставлен - generator.php.
После удаляется папка с файлами постов.
- generation:
vendor - папка parseDown, отвечающая за обработку markdown в html;
archive.php - архивация файлов постов из папки user/name (name - логин). html_archive.php - архивация html файлов (Если выбран этот вариант). Архив начинается с html_ (В этом его отличие от содержащего markdown посты).
delete-dir.php - удаление папки пользователя (производится после архивации).
generator.php - создание .txt файла с содержимым поста, помещение в папку пользователя. html_generator.php делает то же самое, но ещё и конвертирует markdown в html.
- GetDiscussionsByLogin.php - получение из блокчейна постов без учёта лимита. Метод get_discussions_by_blog.
- archives - папка с архивами постов пользователей. Например, мой архив с постами Голоса имеет название "golos_denis-skripnik.zip", а с html файлами постов - "golos_html_d0z4t0r.zip". Для соблюдения анонимности бекапивших архивы не публикуются в Github.
- users - папка с постами пользователей. Туда размещаются файлы, пока не будут архивированы. После архивации папки остаются, но все файлы из них удаляются. В Github не публикуются.

Адрес сервиса: https://dpos.space/backup
Пример на Whaleshares: https://dpos.space/backup/WLS

### 5. Feed: чтение постов тех, на кого подписался пользователь.
Доступен только для Golos, Steem и Whaleshares.
- GetDiscussionsByLogin.php - получение из блокчейна постов без лимита в 100 элементов. Есть постраничная навигация. Метод get_discussions_by_feed.
- index.php - основной файл, где выводится форма на случай отсутствия выбранного блокчейна, форма, если он выбран, а также подключается файл list.php.
- list.php - Список постов подписок. Выводится по запросу логина и при выборе блокчейна. В виде таблицы. Пагинация присутствует. Столбцы: название (со ссылкой), автор (со ссылкой на аккаунт), дата, процент кураторам, теги
- params.php - обычные параметры: заголовки и описания на все случаи жизни :-) (если есть блокчейн, если он не выбран, если введён пользователь или если не введён).

Адрес: https://dpos.space/feed
На примере Голоса и моего аккаунта: https://dpos.space/feed/denis-skripnik/golos

### 6. tags - Теги:
Тут 2 сервиса:
1. Транслитирация тегов. Создавалась для того, чтобы посты, публикуемые через goldvoice, выводились на golos.io. Сейчас это не актуально, т.к. там они не выводятся. Но может кому будет полезно. Выводится на главной сервиса https://dpos.space/tags
2. Список тегов. Берутся из базы данных, куда добавляются при помощи специального файла. Находится по адресу https://dpos.space/tags/all
Тоже давно не обновлял, но возможно кому будет полезен, и начнёт у себя наполнять БД тегами.
Теги берутся на Голосе.

По файлам:
- add_to_db.php - файл добавления в базу данных новых тегов. Парсится get_discussions_by_created Голоса на наличие постов с тегами, которых нет в базе данных. На сервере называется у меня иначе, чтоб не создавали нагрузку обращениями к url.
- db.php - записываются данные подключения к Mysql базе данных. В github опубликована версия с почти стандартными данными.
- eng-ru.php - Перевод уже транслитирированных тегов на Русский (ru--dom - дом).
- index.php - основной файл, в котором выводится форма для ввода тегов через запятую, происходит их разбиение и транслитирация. После этого результат выводится ниже формы.
- list.php - список тегов из базы данных. Ссылка с названием, транслит (если тег на Русском был записан в БД, производится его транслитирация. Если же в уже транслитирированном виде - сам тег) и Количество постов в новом (Значение берётся из базы данных).
- params.php - параметры: заголовки и описания и текст для футера (одвала сайта).
- ru-eng.php - транслит Русских тегов в Английский (дом в ru--dom).

### В корне dpos.space:
Помимо сервисов там есть следующие папки и файлы:
1. .htaccess - файл, где настроен основной файл index.html или index.php, установлена дифолтной кадировкой UTF-8, установлена возможность перехода в режим разработки.
2. _maintenance.enable - убрав первый символ в этом файле, включить можно режим обслуживания (разработки). В файле maintenance.html содержится текст и код, который появляется при включённом maintenance режиме.
3. composer.json и composer.lock - composer файлы, где прописаны установленные библиотеки. Здесь - php-graphin-node-client и всё необходимое для его работы.
4. helpers.php - подключение к блокчейнам (connectors php-node-client) и перевод дат в удобочитаемый вид с названием месяцев. Также там подключается noCache, которая отключает кеширование.
5. home.php - заголовки и описания для главной страницы https://dpos.space
6. index.php - основной файл. Подключаются params.php, helper.php, urls.php и производится запись логов посещений сервисов.
7. params.php, где прописаны различные условия для сервисов, а также подключены файлы params.php самих сервисов.
8. urls.php - ЧПУ (человекопонятные url). Позволяет использовать адреса вида https://dpos.space/profiles/denis-skripnik/viz вместо https://dpos.space/index.php?service=profiles&user=denis-skripnik&blockchain=viz
9. users.log - лог посещений сервисов пользователями. Если кто-то посетил профиль с логином den, а потом пошёл в бекапы, то посещения от имени аккаунта den будут. Конечно, это не показывает, что именно den был там, но позволяет предполагать это. Мне этого достаточно - я не стал заморачиваться. Файл состоит из даты и времени посещения, логина пользователя, сервиса и блокчейна. В Github файл пустой.
10. vendor. Здесь находится всё необходимое для работоспособности php-node-client.
11. template - папка с шаблоном сайта. Здесь можно найти
header.php (Верхняя часть сайта:
секция head и начала body),
menu.php - Меню.
Причём в зависимости от блокчейна выводятся разные пункты, если это требуется. Также при переходе, например, из сервиса профиля с пользователем и блокчейном в фиды, они сохранятся в адресной строке, а значит, просмотрев данные пользователя name в блокчейне steem, вы сможете потом почитать посты его подписчиков в том-же блокчейне.
content.php - подгрузка контентной части сайта. Тут берутся файлы index.php сервисов.
footer.php - нижняя часть сайта: копирайт, ссылки, просьбы и прочее.
favicon.ico - иконка сайта.
form_feed_next.php - постраничная навигация для сервиса feed.
form_with_select.php - форма со списком выбора блокчейна. Используется в feed.
form_without_select.php - без select выбора блокчейна.
template/css - папка с файлами стилей. famaly-Rubik.css - шрифты, normalize.css., style.min.css - основной файл стилей.
    - js/libs: jquery и garlic.min.js (для автозаполнения форм).
js/index.js - основной файл сервисов dpos.space.

#### Подробнее об основном Javascript файле:
В нём прописаны следующие функции:
1. Ajax переключение блокчейнов с редиректом url в адресной строке;
2. Передача файлам вкладок profiles данных: название блокчейна, логин пользователя, а если вкладка с пагинацией, некоторые другие данные, например, номер страницы.
3. Прописываются url сервисов и их названия.
4. Различные условия и ajax подключения для сервисов.

## Всё.
Буду рад пулл-реквестам и форкам сервиса.

## Автор:
Денис Скрипник. Незрячий программист, пользователь блокчейнов Steem, Golos, Viz, Whaleshares.
Адреса аккаунтов:
Steem: https://steemit.com/@denis-skripnik
Golos: https://golos.io/@denis-skripnik
Viz: https://viz.world/@denis-skripnik/
Whaleshares: https://whaleshares.io/@denis-skripnik