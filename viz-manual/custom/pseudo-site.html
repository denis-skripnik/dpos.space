<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="utf-8">
	<title>Hello world</title>
	<meta name="description" content="">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>

<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.8/sjcl.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/viz-js-lib@latest/dist/viz.min.js"></script>
	<form id="test" class="generated-form">
	<fieldset>
	<legend>a</legend>
	<fieldset>
	<legend>b</legend>
	<input type="hidden" name="a[b][c][]" value="1">
	<input type="hidden" name="a[b][c][]" value="2">
	</fieldset>
	</fieldset>
	
	<input type="hidden" name="viz_json_operation_name" id="viz_json_operation_name" value="action2">
	<p><button>Отправить</button></p>
	</form>
	<script>!function(){function e(e){if(localStorage.getItem("viz_login")&&localStorage.getItem("vizPostingKey"))viz_login=localStorage.getItem("viz_login"),posting_key=sjcl.decrypt(viz_login+"_postingKey",localStorage.getItem("vizPostingKey"));else if(sessionStorage.getItem("viz_login")&&sessionStorage.getItem("vizPostingKey"))viz_login=sessionStorage.getItem("viz_login"),posting_key=sjcl.decrypt(viz_login+"_postingKey",sessionStorage.getItem("vizPostingKey"));else{document.getElementById(e)&&(document.getElementById(e).style.display="none");var t=document.createElement("div");t.innerHTML='<form id="auth_form" action="index.html" method="GET"><p class="auth_title"><strong>Пожалуйста авторизируйтесь</strong></p><p><input type="text" id="this_login" name="viz_login" placeholder="Ваш логин"></p><p><input type="password" name="posting" id="this_posting" placeholder="Приватный regular (регулярный) ключ"></p><p><input type="submit" value="Войти"></p></form>',document.getElementById(e).parentNode.insertAdjacentElement("beforeend",t),document.getElementById("auth_form").onsubmit=function(t){t.preventDefault(),async function(e){let t=document.getElementById("this_login").value,o=document.getElementById("this_posting").value;if(localStorage.getItem("vizPostingKey"))var n=sjcl.decrypt(t+"_postingKey",localStorage.getItem("vizPostingKey"));else if(sessionStorage.getItem("vizPostingKey"))var n=sjcl.decrypt(t+"_postingKey",sessionStorage.getItem("vizPostingKey"));else var n=o;if(!0===viz.auth.isWif(n)){const e=await viz.api.getAccountsAsync([t]),s=viz.auth.wifToPublic(n);let i=[];if(e.length>0)for(key of e[0].regular_authority.key_auths)i.push(key[0]);else window.alert("Вероятно, аккаунт не существует. Просьба проверить введённый логин.");i.includes(s)?(localStorage.setItem("viz_login",t),localStorage.setItem("vizPostingKey",sjcl.encrypt(t+"_postingKey",o)),sessionStorage.setItem("viz_login",t),sessionStorage.setItem("vizPostingKey",sjcl.encrypt(t+"_postingKey",o)),viz_login=t,posting_key=n):0===e.length?window.alert("Аккаунт не существует. Пожалуйста, проверьте его"):window.alert("regular ключ не соответствует пренадлежащему аккаунту.")}else window.alert("Regular ключ имеет неверный формат. Пожалуйста, попробуйте ещё раз.");viz_login||posting_key?(document.getElementById(e)&&(document.getElementById(e).style.display="block"),document.getElementById("auth_form").remove()):alert("Не удалось авторизироваться с текущей парой логин/ключ")}(e)}}}var t=document.querySelector(".generated-form").id;document.querySelector(".generated-form").querySelector("button").disabled=!0;setTimeout(function o(){window.hasOwnProperty("viz")?(console.log("done"),function(){const e=["wss://viz.lexai.host/ws","wss://solox.world/ws"];let t=localStorage.getItem("viz_node")||e[0];const o=Math.max(e.indexOf(t),0),n=o=>{o>=e.length&&(o=0),0>=e.length?alert("no working nodes found"):(t=e[o],viz.config.set("websocket",t),viz.api.getDynamicGlobalPropertiesAsync().then(e=>{console.log("found working node",t),localStorage.setItem("viz_node",t)}).catch(e=>{console.log("connection error",t,e),n(o+1)}))};n(o)}(),e(t),document.querySelector(".generated-form").querySelector("button").disabled=!1):(console.log("wait"),setTimeout(o,50))},0);document.querySelector(".generated-form").onsubmit=function(e){e.preventDefault(),this.querySelector("button").disabled=!0;var t=new XMLHttpRequest;t.open("POST","https://dpos.space/blockchains/viz/apps/custom-generator/json_encode.php"),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.onload=function(){200===t.status?(console.log(t.responseText),toArr=JSON.parse(t.responseText),result_json=JSON.stringify([document.querySelector(`#viz_json_operation_name`).value,toArr]),viz.broadcast.custom(posting_key,[],[viz_login],document.querySelector(".generated-form").id,result_json,function(e,t){e?alert("Ошибка: "+e):(alert("Ок. custom отправлен"),console.log(t)),document.querySelector(".generated-form").querySelector("button").disabled=!1})):alert("Request failed.  Returned status of "+t.status)},t.send(function(e){for(var t=[],o=0;o<e.elements.length;o++){var n=e.elements[o];if(n.name&&!n.disabled&&"file"!==n.type&&"reset"!==n.type&&"submit"!==n.type&&"button"!==n.type)if("select-multiple"===n.type)for(var s=0;s<n.options.length;s++)n.options[s].selected&&t.push(encodeURIComponent(n.name)+"="+encodeURIComponent(n.options[s].value));else("checkbox"!==n.type&&"radio"!==n.type||n.checked)&&t.push(encodeURIComponent(n.name)+"="+encodeURIComponent(n.value))}return t.join("&")}(document.querySelector(".generated-form")))}}()</script>
</body></html>